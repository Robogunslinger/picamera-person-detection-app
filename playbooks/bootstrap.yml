- name: "Install dependencies and run picamera person-detection app"
  hosts: "picamera"
  gather_facts: false
  vars:
    picamera_dir: "{{ PICAMERA_DIR | default('/home/pi/picamera-person-detection-app') }}"
  tasks:
    - name: "Clone picamera-person-detection-app"
      git:
        repo: 'https://github.com/Robogunslinger/picamera-person-detection-app'
        dest: "{{ picamera_dir }}"
    - name: "Install virtualenv"
      shell:
        cmd: pip3 install virtualenv
    - name: Create virtual environment
      shell: python3 -m virtualenv -p $(which python3) .venv
      args:
        creates: "{{ picamera_dir }}/.venv"
        chdir: "{{ picamera_dir }}"
    - pip:
        chdir: "{{ picamera_dir }}"
        requirements: "{{ picamera_dir }}/requirements.txt"
        virtualenv: "{{ picamera_dir }}/.venv"
    - name: "Run shell command"
      shell: source .venv/bin/activate && sh run_app.sh
      args:
          chdir: "{{ picamera_dir }}"
